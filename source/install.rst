Инструкция по установке кластера
================================
В инструкции приведены сведения необходимые для подготовки к установке
кластера Arenadata Hadoop, к его настройке и запуску.

Инструкция может быть полезна администраторам, программистам,
разработчикам и сотрудникам подразделений информационных технологий,
осуществляющих внедрение кластера.

Контактная информация службы поддержки:

E-mail: info@arenadata.io



.. toctree::
   :maxdepth: 2
   :caption: Оглавление:

   install/download
   install/prepare
   install/install
   install/master
   install/cluster
   install/annex



Запуск мастера установки
------------------------

Для создания кластера необходимо после входа в Ambari запустить мастер
установки, нажав в главной экранной форме кнопку Launch Install Wizard. Мастер установки проводит по шагам, необходимым для
создания нового кластера ADH. Некоторые этапы установки требуют
особого внимания:


+ Изменение URL-адреса репозитория YUM;
+ Ввод имен хостов и SSH-ключа;
+ Ручная установка Ambari-агентов;
+ Выбор сервисов;
+ Назначение мастер-компонентов;
+ Назначение Slave и Client;
+ Дополнительные настройки сервисов.



Изменение URL-адреса репозитория YUM
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


Для того чтобы открыть список репозиториев YUM необходимо в блоке
Stacks установить флаг в поле ADH 1.4 и раскрыть блок Advanced
Repository Options, при этом Ambari выберет RPM со стеком ADH.

.. _install-img-4:

.. figure:: imgs/install_4.*
   :align: center
   
   Рис.4. Выбор стека


Указанные значения URL необходимо заменить на URL-адреса ранее
установленных репозиториев стека.

Следует заменить значение http://SET_REPO_URL соответствующей ссылкой
репозитория, которая была получена при запуске скрипта setup_repo.sh.
Данный URL-адрес всегда можно уточнить в файле
/etc/yum.repos.d/-.repo.

Репозитории можно обновить после развертывания кластера через Ambari
UI (Admin – Repositories).


Ввод имен хостов и SSH-ключа
^^^^^^^^^^^^^^^^^^^^^^^^^^^^


В разделе Install Options следует указать имена доменов FQDN для
хостов, которые будут содержать кластер. Можно использовать выражение
диапазона с помощью квадратных скобок, например, host [01-10].domain
описывает 10 хостов. В случае если применяется EC2, необходимо
использовать имена внутренних частных DNS-узлов.

Для автоматической регистрации Ambari-агентов на узлах кластера
необходимо ввести закрытый ключ, который использовался для настройки
беспарольного SSH для кластера. Можно выбрать данный файл или
скопировать и вставить его содержимое в экранную форму.



Ручная установка Ambari-агентов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


В случае если нет возможности предоставить закрытый ключ беспарольного
SSH, следует произвести установку Ambari-агентов вручную.
Для этого необходимо выполнить следующие шаги:


+ Установить репозиторий Ambari, скопировав файл /etc/yum.repos.d/
  ambari.repo с сервера репозитория YUM на все узлы кластера;
+ Установить Ambari-агент, выполнив команду:

    :command:`yum install ambari-agent`
    

+ Изменить конфигурацию Ambari-агента /etc/ambari-agent/conf/
  ambari-agent.ini для определения его на сервере Ambari:

    + [server]
    + hostname={ambari.server.hostname}
    + url_port=8440
    + secured_url_port=8441


+ Запустить Ambari-агент, выполнив команду:

    :command:`ambari-agent start`
    
Ambari-агент зарегистрируется на сервере при его запуске.


Выбор сервисов
^^^^^^^^^^^^^^


Необходимо выбрать сервисы ADH, которые следует установить. Сервисы
необходимо выбрать на начальном этапе установки. При этом для любой
инсталляции следует установить HDFS и Zookeeper, остальные сервисы
возможно установить позднее.

.. _install-img-5:

.. figure:: imgs/install_5.*
   :align: center
   
   Рис.5. Выбор сервисов


В случае если выбирается сервис Ambari Metrics, то для контроля
кластера можно использовать Ambari. Если данный сервис не выбирается,
выдается предупреждение, которое можно игнорировать в случае, если
кластер планируется контролировать с помощью других инструментов. При
этом Ambari Metrics можно будет добавить в кластер позднее.


Назначение мастер-компонентов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


Необходимо назначить мастер-компоненты для узлов кластера.

.. _install-img-6:

.. figure:: imgs/install_6.*
   :align: center
   
   Рис.6. Назначение мастер-компонентов

.. important:: Если Hive Metastore использует новую базу данных PostgreSQL, компонент HIVE METASTORE не должен находиться на хосте AMBARI

Данное ограничение объясняется тем, что оба сервиса будут пытаться
использовать порт 5432. В случае абсолютной необходимости совместного
размещения указанных компонентов на одном и том же хосте,
предварительно следует переконфигурировать базу данных PostgreSQL на
порт, отличный от 5432, и выбрать опцию Existing PostgreSQL Database
для конфигурации Hive Metastore.


Назначение Slave и Client
^^^^^^^^^^^^^^^^^^^^^^^^^


Необходимо назначить сервисные компоненты Slave и Client для узлов
кластера.

.. _install-img-7:

.. figure:: imgs/install_7.*
   :align: center
   
   Рис.7. Назначение Slave и Client


В настоящее время полоса прокрутки панели пользовательского
интерфейса, отображающей список услуг для каждого хоста, не
отображается. Необходимо прокрутить главную область страницы вправо,
чтобы убедиться, что все компоненты настроены правильно.


Дополнительные настройки сервисов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


На экранной форме отображаются параметры конфигурации отдельных
сервисов, автоматически сгенерированных установщиком Ambari на основе
параметров кластера. Параметры каждого сервиса можно менять по своему
усмотрению в зависимости от планируемого использования того или иного
компонента кластера.

В случае если для какого-либо обязательного параметра установщик не
может предложить значение по умолчанию, перед продолжением установки
данные параметры необходимо указать вручную (на Рис. 8. приведен
пример, когда для компонента Hive необходимо указать пароль для
внутренней базы данных Hive).

.. _install-img-8:

.. figure:: imgs/install_8.*
   :align: center
   
   Рис.8. Дополнительные настройки сервисов


Установка, запуск и тестирование
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

На экранной форме отображается ход развертывания кластера на каждом
хосте.


.. _install-img-9:

.. figure:: imgs/install_9.*
   :align: center
   
   Рис.9. Ход развертывания кластера


Каждый компонент, который разворачивается вместе с хостом,
устанавливается, запускается и проходит простой тест для проверки
работоспособности.

При этом есть возможность просмотра подробной информации о завершенных
и ожидающих задачах для каждого хоста (Рис. 10.). Для этого необходимо
нажать ссылку в столбце Message (см. Рис. 9.).

.. _install-img-10:

.. figure:: imgs/install_10.*
   :align: center
   
   Рис.10. Информация о задачах хоста


По завершению установки компонентов появляется сообщение Successfully
installed and started the services, в котором необходимо нажать кнопку
Next.

Для окончания установки необходимо на странице Summary проверить
список завершенных задач и нажать кнопку Complete. При этом
открывается панель инструментов кластера.


Панель кластера
---------------


Панель инструментов является центральным местом и отображает
развернутые сервисы и их статус. Здесь можно добавлять новые сервисы
или хосты, останавливать и запускать сервисы и компоненты,
анализировать показатели мониторинга и выполнять конкретные действия
сервиса.

.. _install-img-11:

.. figure:: imgs/install_11.*
   :align: center    
   
   Рис.11. Панель кластера


Приложение 1. Ручная настройка подключения к базе данных
--------------------------------------------------------


Если в процессе настройки сервера Ambari необходимо
отличное от используемого по умолчанию подключение к базе данных
следует в командной строке нажать клавишу y:

:command:`Enter advanced database configuration`

Если инстанс PostgreSQL настроен на порт, отличный от предлагаемого по
умолчанию, для настройки Ambari необходимо выполнить следующие шаги:


+ Открыть в текстовом редакторе конфигурационный файл PostgreSQL
  /var/lib/pgsql/data/pg_hba.conf. Чтобы позволить пользователю ambari
  подключиться к базе данных, необходимо в конце файла добавить
  следующие строки:


    :command:`local all ambari md5`
    
    :command:`host all ambari 0.0.0.0/0 md5`
    
    :command:`host all ambari ::/0 md5`
    

+ Чтобы подключить порт, выбранный не по умолчанию, следует открыть
  файл /etc/sysconfig/pgsql/postgresql и добавить в него строку с
  номером необходимого порта. Например, чтобы подключить порт 10432
  следует указать:


    :command:`PGPORT=10432`
    

+ Перезапустить базу данных PostgreSQL:


    :command:`service postgresql restart`
    

+ Подключиться к базе данных под postgres (супер-пользователь) и
  выполнить следующие настройки:


    :command:`psql -U postgres -p 10432;`
    
    :command:`postgres=# CREATE DATABASE ambari;`
    
    :command:`postgres=# CREATE USER ambari WITH ENCRYPTED PASSWORD 'bigdata';`
    
    :command:`postgres=# \c ambari;`
    
    :command:`ambari=# CREATE SCHEMA ambari AUTHORIZATION ambari;`
    
    :command:`ambari=# ALTER SCHEMA ambari OWNER TO ambari;`
    
    :command:`ambari=# ALTER ROLE ambari SET search_path to 'ambari','public';`
    
    :command:`ambari=# \q`
    
   
+ Выполнить команду установки Ambari:


    :command:`ambari-server setup --database=postgres --databasehost=localhost--databaseport=10432 --databasename=ambari --databaseusername=ambari--databasepassword=bigdata`
    

+ Чтобы убедиться, что postgres подключен к хосту databasehost,
  необходимо использовать следующую команду:


    :command:`netstat -anp | egrep <port>`
    
+ Выполнить файл Ambari-DDL-Postgres-CREATE.sql в PostgreSQL для
  завершения настройки:


    :command:`psql -f /var/lib/ambari-server/resources/Ambari-DDL-Postgres-CREATE.sql -U ambari -p 10432 -d ambari`
    

+ При запросе пароля необходимо ввести значение bigdata.




.. _Справочному руководству Ambari: https://pivotalhd.docs.pivotal.io/docs/reference-guide-ambari-2.1.2.html#_optional_changing_the_default_ambari_server_port
.. _io: mailto:info@arenadata.io
.. _http://arenadata.io/adru-download.html#arenadata-ru-download-easydown: http://arenadata.io/adru-download.html#arenadata-ru-download-easydown



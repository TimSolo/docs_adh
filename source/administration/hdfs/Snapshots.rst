Снапшоты
==========

Снапшот **HDFS** -- это снимок файловой системы на момент времени, доступен только для чтения. Снапшоты могут быть сделаны в поддереве файловой системы или во всей файловой системе. Распространенные случаи использования моментальных снимков -- резервное копирование данных, защита от ошибок пользователя и аварийное восстановление.

Реализация снапшотов **HDFS** очень рациональна:

+ Создание снапшота происходит мгновенно: стоимость *O(1)* без учета времени поиска inode;

+ Дополнительная память используется только при внесении изменений относительно снапшота: использование памяти равно *O(M)*, где *M* -- количество измененных файлов/каталогов;

+ Блоки в datanodes не копируются: файлы снапшота записывают список блоков и размер файла. Копирование данных не производится.

Снапшоты могут быть сделаны в любом каталоге, как только этот каталог установлен как *snapshottable*. Каталог *snapshottable* способен вместить *65 536* одновременных снимков, при этом количество директорий *snapshottable* не ограничено. Администраторы могут задать для любого каталога значение *snapshottable*. Данный каталог нельзя ни удалить, ни переименовать, пока в нем находятся снапшоты.

Вложенные каталоги в *snapshottable* в настоящее время не допускаются. Другими словами, директория не может быть установлена как *snapshottable*, если хотя бы один ее каталог-родитель или каталог-потомок является *snapshottable*.

Для доступа к снапшотам каталога *snapshottable* используется компонент пути ``.snapshot``. Например, */foo* -- каталог *snapshottable*, тогда */foo/bar* является файлом/директорией в нем, где */foo* имеет снапшот *s0*. В результате путь */foo/.snapshot/s0/bar* ссылается на копию снимка */foo/bar*. Обычный API и CLI могут работать с путями ``.snapshot``. Далее приведены некоторые примеры.

+ Перечисление всех снапшотов в директории *snapshottable*:

::

 hdfs dfs -ls /foo/.snapshot

+ Перечисление файлов в снапшоте *s0*:

::

 hdfs dfs -ls /foo/.snapshot/s0

+ Копирование файла из снапшота *s0*:

::
 
 hdfs dfs -cp -ptopax /foo/.snapshot/s0/bar /tmp

.. important:: В примере используется опция preserve для сохранения меток времени, владельца, прав доступа, списков ACL и XAttrs


Обновление до версии HDFS со снапшотами
-----------------------------------------

Функция снапшота в **HDFS** вводит новое зарезервированное имя пути, используемое для взаимодействия со снимками: ``.snapshot``. При обновлении с более старой версии **HDFS**, которая не поддерживает снапшоты, существующие пути с именем ``.snapshot`` необходимо сначала переименовать или удалить, чтобы избежать конфликта с зарезервированным путем в актуальной верии системы. 


Snapshot Operations
--------------------





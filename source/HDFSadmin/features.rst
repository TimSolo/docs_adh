Реализация POSIX ACL на HDFS
=============================

Списки **ACL** на **HDFS** реализуются с помощью модели **ACL POSIX**, которая работает так же, как и в файловой системе **Linux**:

+ `Совместимость и применение`_;
+ `Доступ`_;
+ `Обратная связь`_;
+ `Обратная совместимость`_;
+ `Ограничения`_;
+ `Символические ссылки`_;
+ `Снапшоты`_;
+ `Инструментарий`_;
+ `Доступ нескольким пользователям`_;
+ ``_;
+ ``_;


Совместимость и применение
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

**HDFS** может связывать дополнительный список **ACL** с любым файлом или каталогом. Все операции **HDFS**, которые обеспечивают соблюдение разрешений, выраженных с помощью **Permission Bits**, также должны обеспечить любой **ACL**, который определен для файла или каталога. Так же как и любая существующая логика, которая обходит **Permission Bits**, обходит и **ACL**. Включая супер-пользователя **HDFS** и установку ``false`` в конфигурации *dfs.permissions*.



Доступ 
^^^^^^^

**HDFS** поддерживает операции по настройке и получению **ACL**, связанного с файлом или каталогом. Эти операции доступны через несколько ориентированных на пользователя конечных точек. Эти конечные точки включают **FsShell CLI**, программную манипуляцию через классы **FileSystem** и **FileContext**, **WebHDFS** и **NFS**. 



Обратная связь 
^^^^^^^^^^^^^^^

К разрешениям любого файла или каталога с **ACL** добавляется символ ``+`` (результат по команде ``ls -l``).



Обратная совместимость
^^^^^^^^^^^^^^^^^^^^^^^^

Реализация **ACL** обратно совместима с существующими **Permission Bits**. Изменения, применяемые посредством разрешенных битов (то есть ``chmod``), также отображаются как изменения в **ACL**. Аналогично, изменения, применяемые к записям **ACL** для базовых классов пользователей ("Owner", "Group" и "Other"), отображаются в виде изменений в **Permission Bits**. 

Другими словами, операции **Permission Bits** и **ACL** управляют совместно используемой моделью, и операции **Permission Bits** можно рассматривать как подмножество операций **ACL**.



Накладные расходы
^^^^^^^^^^^^^^^^^^^

Добавление **ACL** не приводит к негативному влиянию на потребление системных ресурсов при развертывании. Он включает в себя процессор, память, диск и пропускную способность сети. Но использование списков **ACL** влияет на производительность **NameNode**, поэтому рекомендуется использовать **Permission Bits**, прежде чем использовать **ACL**.



Ограничения 
^^^^^^^^^^^^

Количество записей в одном списке **ACL** ограничено максимум до *32*. Попытки добавить записи **ACL** сверх максимума выполняются с ошибкой, обращенной к пользователю. Это делается по двум причинам: упростить управление и ограничить потребление ресурсов. 

Списки **ACL** с большим количеством записей, как правило, трудно понять и могут указывать на то, что требования лучше устраняются путем определения дополнительных групп или пользователей. Также такие списки требуют большей памяти и хранилища, и для каждой проверки разрешений требуется больше времени. 



Символические ссылки
^^^^^^^^^^^^^^^^^^^^^^

У символических ссылок нет собственных списков **ACL**, поэтому они рассматривается как разрешения по умолчанию (*777* в **Permission Bits**). Операции, которые изменяют список символической ссылки, вместо этого изменяют саму символическую ссылку.



Снапшоты
^^^^^^^^^^

При создании снапшота все списки **ACL** блокируются. Изменения в **ACL** в момент создания снапшота не фиксируются.



Инструментарий
^^^^^^^^^^^^^^^^^

Инструментарий для **Permission Bits** не подходит для **ACL**. Списки включаются командой оболочки ``cp -p`` и ``distcp -p``. 



Доступ нескольким пользователям
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Когда нескольким пользователям требуется доступ для чтения к файлу и при этом ни один из пользователей не является владельцем файла. Кроме того пользователи не являются членами общей группы, поэтому невозможно использовать групповые разрешения. В таком случае устанавливается ACL-доступ, содержащий несколько именованных пользовательских записей:

::

 ACLs on HDFS supports the following use cases:



Доступ нескольким группам
^^^^^^^^^^^^^^^^^^^^^^^^^^^

Когда нескольким группам требуется чтение и запись в файл и при этом нет группы, объединяющей всех необходимых пользователей, поэтому невозможно использовать групповые разрешения. В таком случае устанавливается ACL-доступ, содержащий несколько именованных групповых записей:

::

 group:sales:rw-
 group:execs:rw-



Hive Partitioned Tables 
^^^^^^^^^^^^^^^^^^^^^^^^^^

В данном случае **Hive** содержит секционированную таблицу данных о продажах. Ключ раздела – *country*. **Hive** сохраняет секционированные таблицы с помощью отдельного подкаталога для каждого определенного значения ключа раздела, поэтому структура файловой системы в **HDFS** выглядит так:
::

 user
 `-- hive
     `-- warehouse 
         `-- sales 
             |-- country=CN 
             |-- country=GB
             `-- country=US

Группа *salesadmin* – это группа для всех этих файлов. Члены группы имеют доступ на чтение и запись ко всем файлам. Отдельные группы, зависящие от конкретной страны, могут запускать запросы на использование, которые только считывают данные для конкретной страны, например, *sales_CN*, *sales_GB* и *sales_US*. У этих групп нет доступа на запись.

Этот вариант использования можно решить, установив **ACL** доступ в каждом подкаталоге, содержащем запись собственной группы и именованной группы:
::

 country=CN
 group::rwx
 group:sales_CN:r-x 

 country=GB
 group::rwx
 group:sales_GB:r-x

 country=US
 group::rwx 
 group:sales_US:r-x

.. important:: Функциональность записи ACL группы владельца (запись группы без имени) эквивалентна установленным Permission Bits

Хранение в **Hive** в настоящее время не учитывает разрешения **ACL** в **HDFS**. Скорее, он проверяет доступ с использованием традиционной модели разрешений **POSIX**.



ACL по умолчанию
^^^^^^^^^^^^^^^^^^^

В данном случае администратор файловой системы или владелец поддерева хотел бы определить политику доступа, которая будет применяться ко всему поддереву. Эта политика доступа должна применяться не только к текущему набору файлов и каталогов, но также к любым новым файлам и каталогам, которые будут добавляться позже.

Этот вариант использования можно решить, установив **ACL по умолчанию** в каталог. **ACL по умолчанию** может содержать любую произвольную комбинацию записей. Например:
::

 default:user::rwx
 default:user:bruce:rw- 
 default:user:diana:r-- 
 default:user:clark:rw-
 default:group::r--
 default:group:sales::rw-
 default:group:execs::rw-
 default:others::---

Важно отметить, что **ACL по умолчанию** копируется из каталога во вновь созданные дочерние файлы и каталоги во время их создания. Если изменить **ACL по умолчанию** в каталоге, это не влияет на **ACL** файлов и подкаталогов, которые уже существуют в каталоге. **ACL по умолчанию** никогда не рассматриваются во время исполнения разрешения. Они используются только для определения **ACL**, какие новые файлы и подкаталоги будут автоматически получены при их создании. 



Минимальные ACL/Permissions
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

**ACL** на **HDFS** поддерживают развертывания, использующие **Permission Bits**, а не **ACL** с именованными пользователями и группами. Биты разрешения эквивалентны минимальному **ACL**, содержащему только 3 записи. Например:
::

 user::rw-
 group::r--
 others::---



Блокировка доступа к поддереву для конкретного пользователя
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

В данном примере создано глубокое вложенное подэлемента файловой системы, читаемое во всем мире, к которому устанавливается требование блокировать доступ для конкретного пользователя ко всем файлам этого поддерева.

Этот пример можно решить, установив **ACL** в корневое дерево, с именованной пользовательской записью, которая удаляет весь доступ пользователя. Для этой файловой системы: 
::

 dir1
 `-- dir2
     `-- dir3
         |-- file1
         |-- file2
         `-- file3
 
 dir1`-- dir2`-- dir3|-- file1|-- file2`-- file3

Установка **ACL** на *dir2* блокирует доступ для Bruce к *dir3*, *file1*, *file2* и *file3*:

  :command:`user:bruce:---`

Удаление разрешений на выполнение на *dir2* означает, что Брюс не может получить доступ к *dir2* и, следовательно, не может видеть ни один из его дочерних элементов. Это также означает, что доступ блокируется автоматически для любых вновь добавленных файлов под *dir2*. То есть если *file4* создается под *dir3*, Брюс не сможет получить к нему доступ. 



ACL с Sticky Bit
^^^^^^^^^^^^^^^^^^

В данном случае нескольким именованным пользователям или группам требуется полный доступ к каталогу общего назначения, например, */ tmp*. Однако разрешения "Write" и "Execute" в каталоге также дают пользователям возможность удалять или переименовывать любые файлы в каталоге, даже файлы, созданные другими пользователями. Разрешения пользователей необходимо ограничить, чтобы у них был допуск на удаление или переименование созданных только ими файлов.

Этот случай можно решить, объединив **ACL** с **Sticky bit**. **Sticky bit** – это функциональность, которая в настоящее время работает с **Permission Bits**. И она работает в сочетании с **ACL**. 




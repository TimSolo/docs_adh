Запуск мастера установки
------------------------

Для создания кластера необходимо после входа в **Ambari** запустить мастер
установки, нажав в главной экранной форме кнопку *Launch Install Wizard*. Мастер установки проводит по шагам, необходимым для
создания нового кластера **ADH**. Некоторые этапы установки требуют
особого внимания:


+ Изменение URL-адреса репозитория YUM;
+ Ввод имен хостов и SSH-ключа;
+ Ручная установка Ambari-агентов;
+ Выбор сервисов;
+ Назначение мастер-компонентов;
+ Назначение Slave и Client;
+ Дополнительные настройки сервисов.



Изменение URL-адреса репозитория YUM
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


Для того чтобы открыть список репозиториев **YUM** необходимо в блоке
"Stacks" установить флаг в поле *ADH 1.4* и раскрыть блок "Advanced
Repository Options", при этом **Ambari** выберет *RPM* со стеком *ADH* (:ref:`Рис.7.<install-img-7>`).

.. _install-img-7:

.. figure:: imgs/install_pic7.*
   :align: center
   
   Рис.7. Выбор стека


Указанные значения URL необходимо заменить на URL-адреса ранее
установленных репозиториев стека.

Следует заменить значение *http://SET_REPO_URL* соответствующей ссылкой
репозитория, которая была получена при запуске скрипта *setup_repo.sh*.
Данный URL-адрес всегда можно уточнить в файле
*/etc/yum.repos.d/-.repo*.

Репозитории можно обновить после развертывания кластера через **Ambari
UI** ("Admin – Repositories").


Ввод имен хостов и SSH-ключа
^^^^^^^^^^^^^^^^^^^^^^^^^^^^


В разделе "Install Options" следует указать имена доменов **FQDN** для
хостов, которые будут содержать кластер. Можно использовать выражение
диапазона с помощью квадратных скобок, например, *host [01-10].domain*
описывает 10 хостов. В случае если применяется **EC2**, необходимо
использовать имена внутренних частных DNS-узлов.

Для автоматической регистрации Ambari-агентов на узлах кластера
необходимо ввести закрытый ключ, который использовался для настройки
беспарольного SSH для кластера. Можно выбрать данный файл или
скопировать и вставить его содержимое в экранную форму.



Ручная установка Ambari-агентов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


В случае если нет возможности предоставить закрытый ключ беспарольного
SSH, следует произвести установку Ambari-агентов вручную.
Для этого необходимо выполнить следующие шаги:


+ Установить репозиторий Ambari, скопировав файл */etc/yum.repos.d/
  ambari.repo* с сервера репозитория YUM на все узлы кластера;
+ Установить Ambari-агент, выполнив команду:

    :command:`yum install ambari-agent`
    

+ Изменить конфигурацию Ambari-агента */etc/ambari-agent/conf/
  ambari-agent.ini* для определения его на сервере Ambari:

    + [server]
    + hostname={ambari.server.hostname}
    + url_port=8440
    + secured_url_port=8441


+ Запустить Ambari-агент, выполнив команду:

    :command:`ambari-agent start`
    
Ambari-агент зарегистрируется на сервере при его запуске.


Выбор сервисов
^^^^^^^^^^^^^^


Необходимо выбрать сервисы **ADH**, которые следует установить. Сервисы
необходимо выбрать на начальном этапе установки. При этом для любой
инсталляции следует установить **HDFS** и **Zookeeper**, остальные сервисы
возможно установить позднее (:ref:`Рис.8.<install-img-8>`).

.. _install-img-8:

.. figure:: imgs/install_pic8.*
   :align: center
   
   Рис.8. Выбор сервисов


В случае если выбирается сервис **Ambari Metrics**, то для контроля
кластера можно использовать **Ambari**. Если данный сервис не выбирается,
выдается предупреждение, которое можно игнорировать в случае, если
кластер планируется контролировать с помощью других инструментов. При
этом **Ambari Metrics** можно будет добавить в кластер позднее.


Назначение мастер-компонентов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


Необходимо назначить мастер-компоненты для узлов кластера (:ref:`Рис.9.<install-img-9>`).

.. _install-img-9:

.. figure:: imgs/install_pic9.*
   :align: center
   
   Рис.9. Назначение мастер-компонентов

.. important:: Если Hive Metastore использует новую базу данных PostgreSQL, компонент HIVE METASTORE не должен находиться на хосте AMBARI

Данное ограничение объясняется тем, что оба сервиса будут пытаться
использовать порт *5432*. В случае абсолютной необходимости совместного
размещения указанных компонентов на одном и том же хосте,
предварительно следует переконфигурировать базу данных **PostgreSQL** на
порт, отличный от *5432*, и выбрать опцию "Existing PostgreSQL Database"
для конфигурации **Hive Metastore**.


Назначение Slave и Client
^^^^^^^^^^^^^^^^^^^^^^^^^


Необходимо назначить сервисные компоненты **Slave** и **Client** для узлов
кластера (:ref:`Рис.10.<install-img-10>`).

.. _install-img-10:

.. figure:: imgs/install_pic10.*
   :align: center
   
   Рис.10. Назначение Slave и Client


В настоящее время полоса прокрутки панели пользовательского
интерфейса, отображающей список услуг для каждого хоста, не
отображается. Необходимо прокрутить главную область страницы вправо,
чтобы убедиться, что все компоненты настроены правильно.


Дополнительные настройки сервисов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


На экранной форме отображаются параметры конфигурации отдельных
сервисов, автоматически сгенерированных установщиком **Ambari** на основе
параметров кластера. Параметры каждого сервиса можно менять по своему
усмотрению в зависимости от планируемого использования того или иного
компонента кластера.

В случае если для какого-либо обязательного параметра установщик не
может предложить значение по умолчанию, перед продолжением установки
данные параметры необходимо указать вручную (на :ref:`Рис.11.<install-img-11>` приведен
пример, когда для компонента **Hive** необходимо указать пароль для
внутренней базы данных **Hive**).

.. _install-img-11:

.. figure:: imgs/install_pic11.*
   :align: center
   
   Рис.11. Дополнительные настройки сервисов


Установка, запуск и тестирование
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

На экранной форме отображается ход развертывания кластера на каждом
хосте (:ref:`Рис.12.<install-img-12>`).


.. _install-img-12:

.. figure:: imgs/install_pic12.*
   :align: center
   
   Рис.12. Ход развертывания кластера


Каждый компонент, который разворачивается вместе с хостом,
устанавливается, запускается и проходит простой тест для проверки
работоспособности.

При этом есть возможность просмотра подробной информации о завершенных
и ожидающих задачах для каждого хоста (:ref:`Рис.13.<install-img-13>`). Для этого необходимо
нажать ссылку в столбце Message (см. :ref:`Рис.12.<install-img-12>`).

.. _install-img-13:

.. figure:: imgs/install_pic13.*
   :align: center
   
   Рис.13. Информация о задачах хоста


По завершению установки компонентов появляется сообщение *Successfully
installed and started the services*, в котором необходимо нажать кнопку
*Next*.

Для окончания установки необходимо на странице "Summary" проверить
список завершенных задач и нажать кнопку *Complete*. При этом
открывается панель инструментов кластера.

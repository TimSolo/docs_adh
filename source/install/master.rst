Запуск мастера установки
------------------------

Для создания кластера необходимо после входа в **Ambari** запустить мастер
установки, нажав в главной экранной форме кнопку *Launch Install Wizard*. Мастер установки проводит по шагам, необходимым для
создания нового кластера **ADH**. Некоторые этапы установки требуют особого внимания:


+ Изменение URL-адресов репозиториев YUM;
+ Ввод имен узлов и SSH-ключа или ручная установка Ambari-агентов;
+ Выбор компонентов;
+ Назначение мастер-узлов для компонентов;
+ Назначение Slave и Client узлов;
+ Дополнительные настройки компонентов.



Изменение URL-адресов репозиториев YUM
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^


Для того чтобы открыть список репозиториев **YUM**, необходимо в блоке
"Stacks" установить флаг в поле *ADH 1.4* и раскрыть блок "Advanced
Repository Options", при этом **Ambari** предлагает указать URL-адреса репозиториев (:ref:`Рис.7.<install-img-7>`).

.. _install-img-7:

.. figure:: imgs/install_pic7.*
   :align: center
   
   Рис.7. Выбор стека


В полях "Base URL" необходимо указать URL-адреса репозиториев, которые были получены при запуске скрипта *setup_repo.sh*.
Данные URL-адреса всегда можно уточнить в файлах */etc/yum.repos.d/<имя репозитория>.repo*.

Для установки из публичного репозитория **Arenadata** необходимо выбрать соответствующий пункт меню "Use Public Repository" (:ref:`Рис.8.<install-img-7-2>`).

.. _install-img-7-2:

.. figure:: imgs/install_pic7-2.*
   :align: center
   
   Рис.8. Установка из публичного репозитория

Репозитории можно обновить после развертывания кластера через **Ambari UI** (:menuselection:`"Admin --> Repositories"`).


Ввод имен узлов и SSH-ключа
^^^^^^^^^^^^^^^^^^^^^^^^^^^^


В разделе "Install Options" следует указать полные доменные имена (**FQDN**) для
узлов, которые будут содержать кластер. Можно задавать диапазоны иммен с помощью квадратных скобок, например, *host [01-10].domain*
описывает 10 хостов. В случае если применяется **EC2**, необходимо использовать имена внутренних частных DNS-узлов.

Для автоматической регистрации Ambari-агентов на узлах кластера необходимо ввести закрытый ключ, который использовался для настройки
беспарольного SSH для кластера. Можно передать сам файл *id_rsa* или скопировать и вставить его содержимое в экранную форму.



Ручная установка Ambari-агентов
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~


В случае если нет возможности предоставить закрытый ключ беспарольного SSH, следует произвести установку Ambari-агентов вручную. Для этого на каждом узле кластера необходимо выполнить следующие шаги:


+ Установить репозиторий Ambari, скопировав файл */etc/yum.repos.d/ambari.repo* с сервера репозитория YUM;
+ Установить Ambari-агент, выполнив команду:

    :command:`yum install ambari-agent`
    
+ Изменить конфигурацию Ambari-агента */etc/ambari-agent/conf/ambari-agent.ini* для определения его на сервере Ambari:

    + [server]
    + hostname={ambari.server.hostname}
    + url_port=8440
    + secured_url_port=8441


+ Запустить Ambari-агент, выполнив команду:

    :command:`ambari-agent start`
    
Ambari-агент зарегистрируется на сервере при его запуске.



Выбор компонентов
^^^^^^^^^^^^^^^^^

Необходимо выбрать компоненты **ADH**, которые следует установить. Компоненты необходимо выбрать на начальном этапе установки. При этом для любой инсталляции следует установить **HDFS** и **Zookeeper**, остальные компоненты возможно установить позднее (:ref:`Рис.9.<install-img-8>`).

.. _install-img-8:

.. figure:: imgs/install_pic8.*
   :align: center
   
   Рис.9. Выбор компонентов


В случае если выбирается компонент **Ambari Metrics**, то для контроля кластера можно использовать **Ambari**. Если данный компонент не выбирается, выдается предупреждение, которое можно игнорировать в случае, если кластер планируется контролировать с помощью других инструментов. При этом **Ambari Metrics** можно будет добавить в кластер позднее.



Назначение мастер-узлов
^^^^^^^^^^^^^^^^^^^^^^^

Необходимо назначить мастер-узлы компонентов кластера (:ref:`Рис.10.<install-img-9>`).

.. _install-img-9:

.. figure:: imgs/install_pic9.*
   :align: center
   
   Рис.10. Назначение мастер-узлов

.. important:: Если Hive Metastore использует новую базу данных *PostgreSQL*, компонент HIVE METASTORE не должен находиться на хосте AMBARI

Данное ограничение объясняется тем, что оба компонента будут пытаться использовать порт *5432*. В случае абсолютной необходимости совместного размещения указанных компонентов на одном и том же хосте, предварительно следует переконфигурировать базу данных **PostgreSQL** на порт, отличный от *5432*, и выбрать опцию "Existing PostgreSQL Database" для конфигурации **Hive Metastore**.



Назначение Slave и Client узлов компонентов кластера
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Необходимо назначить **Slave** и **Client** узлы, на которых будут разворачиваться соответствующие компоненты кластера (:ref:`Рис.11.<install-img-10>`).

.. _install-img-10:

.. figure:: imgs/install_pic10.*
   :align: center
   
   Рис.11. Назначение Slave и Client узлов



Дополнительные настройки компонентов
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

На экранной форме отображаются параметры конфигурации отдельных компонентов, автоматически сгенерированных установщиком **Ambari** на основе параметров кластера. Параметры каждого компонента можно менять по своему усмотрению в зависимости от планируемого использования того или иного компонента кластера.

В случае если для какого-либо обязательного параметра установщик не может предложить значение по умолчанию, перед продолжением установки
данные параметры необходимо указать вручную (на :ref:`Рис.12.<install-img-11>` приведен пример, когда для компонентов *Hive*, *Oozie*, *Ambari Metrics*, *Knox* необходимо указать пароли для внутренних баз данных).

.. _install-img-11:

.. figure:: imgs/install_pic11.*
   :align: center
   
   Рис.12. Дополнительные настройки компонентов


Установка, запуск и тестирование
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

На экранной форме отображается ход развертывания кластера на каждом узле (:ref:`Рис.13.<install-img-12>`).


.. _install-img-12:

.. figure:: imgs/install_pic12.*
   :align: center
   
   Рис.13. Ход развертывания кластера


Каждый компонент, который разворачивается вместе с хостом, устанавливается, запускается и проходит простой тест для проверки
работоспособности.

При этом есть возможность просмотра подробной информации о завершенных и ожидающих задачах для каждого хоста (:ref:`Рис.14.<install-img-13>`). Для этого необходимо нажать ссылку в столбце "Message" (см. :ref:`Рис.13.<install-img-12>`).

.. _install-img-13:

.. figure:: imgs/install_pic13.*
   :align: center
   
   Рис.14. Информация о задачах хоста


По завершению установки компонентов появляется сообщение *Successfully
installed and started the services*, в котором необходимо нажать кнопку
*Next*.

Для окончания установки необходимо на странице "Summary" проверить
список завершенных задач и нажать кнопку *Complete*. При этом
открывается панель инструментов кластера.

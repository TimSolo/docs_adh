Настройка Ambari и Hadoop для Kerberos
--------------------------------------

В данной главе описывается настройка **Kerberos** для надежной аутентификации пользователей и хостов **Hadoop** в кластере, 
управляемом **Ambari**:

+	Обзор Kerberos;
+	Принципалы Hadoop и Kerberos;
+	Установка и настройка KDC;
+	Подключение системы безопасности Kerberos в Ambari;
+	Клиентские пакеты Kerberos;
+	Отключение системы безопасности Kerberos в Ambari;
+	Настройка шаблона атрибута.


Обзор Kerberos
^^^^^^^^^^^^^^

Жесткая аутентификация и установление личности пользователя – основа безопасного доступа в **Hadoop**. Пользователи должны 
иметь возможность надежно "идентифицировать" себя, а затем использовать эту идентификацию во всем кластере **Hadoop**. Как 
только это будет сделано, данные пользователи могут получить доступ к ресурсам (например, к файлам или каталогам) или 
взаимодействовать с кластером (например, выполнять задания **MapReduce**). Помимо пользователей, сами ресурсы кластера **Hadoop** 
(такие как хосты и сервисы) должны проходить аутентификацию друг с другом, чтобы избежать потенциально опасных вредоносных 
систем или систем, "позиционирующих себя" как надежные компоненты кластера с целью получения доступа к данным. 

**Hadoop** использует **Kerberos** в качестве основы для строгой аутентификации и обеспечения идентичности пользователям и 
сервисам. **Kerberos** является сторонним механизмом аутентификации, на который полагаются пользователи и сервисы для 
удостоверения подлинности друг друга. Сам сервер **Kerberos** известен как **Key Distribution Center** (**Центр распределения ключей**) 
или **KDC**. Он состоит из трех частей:

+	База данных пользователей и сервисов (известных как принципалы), о которых он знает, и соответствующие пароли Kerberos;
+	Сервер аутентификации (AS), который выполняет первоначальную проверку подлинности и выдает Ticket Granting Ticket (TGT);
+	Ticket Granting Server (TGS) – сервер, который оформляет последующие билеты на основе начального TGT.

Пользователь-принципал запрашивает аутентификацию от **AS**. **AS** отправляет в ответ **TGT**, который зашифрован с 
использованием пароля пользователя-принципала **Kerberos**, известный только пользователю и **AS**. Пользователь-принципал 
расшифровывает **TGT** локально, используя свой пароль **Kerberos**, и с этого момента до истечения срока действия билета 
пользователь-принципал может использовать **TGT** для получения билетов от **TGS**. Данные билеты позволяют принципалу получить 
доступ к различным сервисам.

Поскольку ресурсы кластера (хосты или сервисы) не могут каждый раз предоставлять пароль для расшифровки **TGT**, они 
используют специальный файл *keytab*, который содержит учетные данные аутентификации ресурса. Набор хостов, пользователей и 
сервисов, над которыми сервер **Kerberos** имеет контроль, называется сферой.

.. csv-table:: Термины и определения
   :header: "Термин", "Определение"
   :widths: 25, 25

   "Key Distribution Center, KDC", "Надежный источник для аутентификации в экосистеме с поддержкой Kerberos"
   "Сервер Kerberos KDC ", "Машина или сервер, который служит в качестве центра распределения ключей"
   "Клиент Kerberos", "Любая машина в кластере, которая аутентифицируется с KDC"
   "Принципал", "Уникальное имя пользователя или сервиса, который аутентифицируется с KDC"
   "Keytab", "Файл, содержащий один или несколько принципалов и их ключи"
   "Сфера ", "Сеть Kerberos, включающая KDC и ряд клиентов"
   "KDC Admin Account", "Учетная запись администратора, используемая Ambari для создания принципов и генерации ключей в KDC"
   
   
Принципалы Hadoop и Kerberos
^^^^^^^^^^^^^^^^^^^^^^^^^^^^

Каждый сервис и под-сервис в **Hadoop** должны иметь своего принципала. Имя принципала в данной сфере состоит из основного 
имени и имени экземпляра – это полное доменное имя хоста, на котором работает сервер. Учетные данные серверов хранятся в файле 
*keytab*, который извлекается из базы данных **Kerberos** с помощью принципала сервера и хранится локально в защищенном 
каталоге на узле компонента сервера (:ref:`Рис.1.<admin-img-1>`).


.. _ambari_sec_pic.1:

.. figure:: imgs/ambari_sec_pic.1.*
   :align: center
   
   Рис.1. Права доступа к кластеру

Пример условного обозначения имени принципалов и *Keytabs* приведен в таблице 1.


.. csv-table:: Условное обозначение имени принципалов и Keytabs
   :header: " ", "Условное обозначение", "Пример"
   :widths: 10, 20, 20

   "Principals", "$service_component_name/$FQDN@EXAMPLE.COM", "nn/c6401.ambari.apache.org@EXAMPLE.COM"
   "Keytabs", "$service_component_abbreviation.service.keytab", "/etc/security/keytabs/nn.service.keytab"
   

В дополнение к **Hadoop Service Principals**, сам **Ambari** также требует, чтобы набор Ambari-принципалов выполнял 
служебные "smoke" проверки и проверку работоспособности. Файлы *Keytab* для Ambari-принципалов, или "headless", находятся на 
каждом хосте кластера, так же как и для принципалов сервиса.

В примере условного обозначения имени принципалов и *Keytabs* указано основное имя для каждого сервисного принципала. 
Основа имени, например, *nn* или *hive*, представляют собой соответственно сервис **NameNode** или **Hive**. К основному имени 
добавляется имя экземпляра и полное доменное имя хоста, на котором оно выполняется. Эта схема обеспечивает уникальное имя 
сервисам, которые работают на нескольких хостах, таких как **DataNodes** и **NodeManagers**. Добавление имени хоста служит для 
различия, например, запроса из **DataNode A** и запроса из **DataNode B**. Это важно по следующим причинам:

+	Данные Kerberos для одного DataNode не подвергаются риску совпасть с данными других DataNodes;
+	Если несколько DataNodes имеют одинаковый принципал и одновременно подключаются к одному NameNode, и если аутентификатор 
Kerberos имеет одинаковые временные метки, в таком случае аутентификация отклоняется как повторный запрос.



Установка и настройка KDC
^^^^^^^^^^^^^^^^^^^^^^^^^

**Ambari** может настроить **Kerberos** в кластере для работы с существующим **MIT KDC** или с существующей **Active Directory**. 
В данном разделе описываются шаги, необходимые для подготовки к интеграции.

Если у вас нет существующего **KDC** (**MIT** или **Active Directory**), необходимо установить новый **MIT KDC**. 


.. important:: Установка KDC на узле кластера уже после установки клиента Kerberos может перезаписать созданный Ambari файл krb5.conf

При выборе автоматической настройки **Kerberos** **Ambari** самостоятельно подключается к **KDC**, создает необходимых принципалов, 
генерирует и распространяет *keytabs*. При выборе ручной настройки **Kerberos** необходимо вручную создавать принципалов, 
генерировать и распространять *keytabs*.

+	Использование существующего MIT KDC;
+	Использование существующей Active Directory;
+	Ручная настройка Kerberos;
+	Установка нового MIT KDC.


Использование существующего MIT KDC
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для использования существующего **MIT KDC** для кластера необходимо подготовить:

+	Серверы Ambari и кластеры, имеющие сетевой доступ как к административным узлам KDC, так и к самому KDC;
+	Учетные данные администратора KDC.

Дальнейшие действия описаны в разделе "Подключение системы безопасности Kerberos в Ambari".


Использование существующей Active Directory
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Для использования существующей **Active Directory** для кластера с автоматической установкой **Kerberos** необходимо подготовить:

+	Серверы Ambari и кластеры, имеющие доступ к сети и DNS-именам Domain Controllers;
+	Настроить конфигурацию LDAP (LDAPS) Active Directory;
+	Пользовательскую Active Directory для принципалов. Например, *"OU = Hadoop, OU = People, dc = apache, dc = org"*;
+	Учетные данные администратора Active Directory с с настроенным правом "Создание, удаление и управление учетными записями пользователей".

Дальнейшие действия описаны в разделе "Подключение системы безопасности Kerberos в Ambari".


Ручная настройка Kerberos
~~~~~~~~~~~~~~~~~~~~~~~~~

Для ручной настройки **Kerberos** необходимо подготовить:

+	Сетевой доступ узлов кластера к KDC;
+	Установить утилиты клиента Kerberos (например, *kinit*) на каждом узле кластера;
+	Установить расширения Java Cryptography (JCE) на хосте сервера Ambari Server и на всех узлах кластера;
+	Вручную создать сервисные и Ambari принципалы в KDC перед выполнением мастера;
+	Создать вручную и распространить ключи для принципалов сервисов и Ambari на узлы кластера до перед выполнением мастера.

Дальнейшие действия описаны в разделе "Подключение системы безопасности Kerberos в Ambari".


Установка нового MIT KDC
~~~~~~~~~~~~~~~~~~~~~~~~

В данном разделе приведено подробное описание процесса установки **KDC**:

+	Установка сервера KDC;
+	Создание базы данных Kerberos;
+	Запуск KDC;
+	Создание администратора Kerberos.

.. important:: Поскольку Kerberos является точным к времени протоколом, все хосты в сфере должны синхронизироваться по времени, например, используя протокол сетевого времени (NTP)

Если локальное системное время клиента отличается от времени в **KDC** хотя бы на 5 минут, клиент не сможет аутентифицироваться.


Установка сервера KDC
`````````````````````

Для установки сервера **KDC** необходимо выполнить следующие действия:

№.	Установить новую версию сервера KDC:

+	RHEL / CentOS:

:command:`yum install krb5-server krb5-libs krb5-workstation`

+	SLES:

:command:`Zypper install krb5 krb5-server krb5-client`

№.	Используя текстовый редактор, открыть файл конфигурации сервера KDC, расположенный по умолчанию в *Vi /etc/krb5.conf*;

№.	Изменить раздел *[realms]* этого файла, заменив параметр *kerberos.example.com* для свойств *kdc* и *admin_server*, 
установленный по умолчанию с Fully Qualified Domain Name хоста сервера KDC, как показано в примере, где *kerberos.example.com* 
заменен на *my.kdc.server*:

:command:`[realms]`

 :command:`EXAMPLE.COM = {`
 
   :command:`kdc = my.kdc.server`
   
   :command:`admin_server = my.kdc.server`
   
:command:`}` 


Создание базы данных Kerberos
`````````````````````````````

Для создания базы данных **Kerberos** необходимо использовать утилиту *kdb5_util*:

+	RHEL / CentOS:

:command:`Kdb5_util create -s`

+	SLES:

:command:`Kdb5_util create –s`


Запуск KDC
``````````

Для запуска сервера **KDC** и сервера администратора **KDC** необходимо выполнить команды:

+	RHEL/CentOS 6:

:command:`/etc/rc.d/init.d/krb5kdc start`

:command:`/etc/rc.d/init.d/kadmin start`

+	RHEL/CentOS 7:

:command:`systemctl start krb5kdc`

:command:`systemctl start kadmin`

+	SLES 11:

:command:`rckrb5kdc start`

:command:`rckadmind start`

При установке и управлении собственным **MIT KDC** важно настроить сервер **KDC** на автоматический запуск при загрузке:

+	RHEL/CentOS 6:

:command:`chkconfig krb5kdc on`

:command:`chkconfig kadmin on`

+	RHEL/CentOS 7:

:command:`systemctl enable krb5kdc`

:command:`systemctl enable kadmin`

+	SLES 11:

:command:`chkconfig rckrb5kdc on`

:command:`chkconfig rckadmind on`


Создание администратора Kerberos
````````````````````````````````

Принципалы **Kerberos** могут быть созданы либо на самой машине **KDC**, либо через сеть, используя принципал *admin*. 
В последующей инструкции предполагается, что используется компьютер **KDC** и команда от утилиты администратора *kadmin.local*. 
Использование *kadmin.local* на машине **KDC** позволяет создавать принципалов без необходимости создания отдельного  
принципала "администратора" перед началом работы.

При включении **Kerberos** для подключения **Ambari** к **KDC**, создания кластерных принципалов и генерации *keytabs* 
необходимо предоставить учетные данные администратора **Ambari**.

1.	Создать администратора KDC, путем создания принципала администратора:

:command:`Kadmin.local -q "addprinc admin / admin"`

2.	Убедиться, что созданный администратор имеет права в ACL KDC. Открыть файл ACL KDC, используя текстовый редактор:

+	RHEL / CentOS:

:command:`Vi /var/kerberos/krb5kdc/kadm5.acl`

+	SLES:

:command:`Vi /var/lib/kerberos/krb5kdc/kadm5.acl`

3.	Убедиться, что файл ACL KDC содержит запись, позволяющую принципалу администратора управлять KDC в вашей конкретной сфере. 
При использовании сферы, отличной от *EXAMPLE.COM*, необходимо убедиться, что есть запись для вашей сферы. Например, 
для принципала *admin/admin@HADOOP.COM* следующая запись:

:command:`*/admin@HADOOP.COM *`

4.	После редактирования и сохранения файла *kadm5.acl* необходимо перезапустить процесс *kadmin*:

+	RHEL/CentOS 6:

:command:`/etc/rc.d/init.d/kadmin restart`

+	RHEL/CentOS 7:

:command:`systemctl restart kadmin`

+	SLES 11:

:command:`rckadmind restart`



Подключение системы безопасности Kerberos в Ambari
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
1.4.








